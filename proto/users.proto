syntax = "proto3";

package watchtower;

import "google/protobuf/timestamp.proto";
import "messages.proto";
import "videos.proto";

option go_package = "videoapp/internal/proto";

service Users {
  rpc Create(CreateRequest) returns (CreateResponse);
  rpc Get(UsersGetRequest) returns (UsersGetResponse);
  rpc GetById(UsersGetByIdRequest) returns (UsersGetResponse);

  rpc Verify(VerifyRequest) returns (Empty);

  rpc Follow(FollowRequest) returns (Empty);
  rpc Unfollow(FollowRequest) returns (Empty);

  rpc GetFollowers(GetFollowsRequest) returns (FollowUsers);
  rpc GetFollowing(GetFollowsRequest) returns (FollowUsers);
  rpc GetFollowingVideos(GetFollowingVideosRequest) returns (GetFollowingVideosResponse);

  rpc UploadAvatar(UploadAvatarRequest) returns (Empty);
  rpc RemoveAvatar(Session) returns (Empty);
  rpc UpdateProfile(UpdateProfileRequest) returns (Empty);

  rpc ListRecommendations(ListRecommendationsRequest) returns (ListRecommendationsResponse);
}

message ListRecommendationsRequest {
  string session = 1;
  int32 page = 2;
}
message ListRecommendationsResponse {
  repeated Video videos = 1;
}

message UsersGetByIdRequest {
  int64 id = 1;
  string session = 2;
}

message UpdateProfileRequest {
  string session = 1;
  optional string display_name = 2;
  optional string description = 3;
}

message UploadAvatarRequest {
  string session = 1;
  bytes data = 2;
}

message GetFollowingVideosRequest {
  int64 user_id = 1;
  int32 page = 2;
}
message GetFollowingVideosResponse {
  repeated Video videos = 1;
}
message Video {
  int64 id = 1;
  string title = 2;
  Visibility visibility = 3;
  google.protobuf.Timestamp created_at = 4;
  int64 thumbnail_id = 5;
  Stage stage = 6;
  int64 user_id = 7;
  string username = 8;
}
message CreateRequest {
  string email = 1;
  string username = 2;
  string password = 3;
}
message CreateResponse {
  uint64 id = 1;
}
message VerifyRequest {
  string session = 1;
  int32 code = 2;
}
message FollowRequest {
  string session = 1;
  int64 id_to_follow = 2;
}
message UsersGetRequest {
  string session = 1;
  string username = 2;
}
message UsersGetResponse {
  User user = 1;
  bool is_following = 2;
}
message GetFollowsRequest {
  int64 user_id = 1;
  int32 page = 2;
}
message FollowUsers {
  repeated FollowUser users = 1;
}
message FollowUser {
  int64 user_id = 1;
  google.protobuf.Timestamp created_at = 2;
  string username = 3;
}
service Sessions {
  rpc Create(Crededentials) returns (Session) {}
  rpc GetUser(Session) returns (User) {}
  rpc Delete(Session) returns (Empty) {}
}
message User {
  int64 id = 1;
  string email = 2;
  string username = 3;
  google.protobuf.Timestamp created_at = 4;
  uint64 flags = 5;
  int64 follower_count = 6;
  int64 following_count = 7;
  string display_name = 8;
  string description = 9;
}
message Crededentials {
  string email = 1;
  string password = 2;
}
message Session {
  string token = 1;
}
